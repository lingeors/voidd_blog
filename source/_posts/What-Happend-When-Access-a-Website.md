---
title: 从输入url到页面显示过程发生了什么
date: 2017-07-07 00:02:13
tags:
    - 网络
---
> 当我们访问一个网站时，实际上发生了什么？突然想要写这样一篇文章，秉着越详细越好的原则，会持续更新

<!-- more -->

2017-07-07 01:26:50 init 简易版本

1. 首先，我们向浏览器键入链接 `https://www.google.com`
2. 通过 DNS协议获取ip：计算机首先向本机填写的本地dns服务器发送一个dns请求，用来获取`www.google.com`的ip，该步骤是递归的，然后本地dns服务器向根dns服务器发送请求获取顶级域服务器的ip，再通过该ip向顶级域dns服务器发送dns请求获取权威dns服务器的ip，接着向该权威dns服务器发送请求获取请求域名 `www.google.com` 的ip，该过程是迭代的，最后将该ip响应给我们的计算机。dns请求使用的是udp协议。
3. 接下来生成一个http报文，使用获取到的ip地址、浏览器相关信息、通过链接解析出来的相关信息如端口，主机等等。
4. http报文进入传输层进行包装，计算机先创建socket，并指定使用的传输层协议，如tcp或udp。以tcp为例，从应用层获得的http报文数据会被拆分成一定大小的数据块，并添加上tcp首部相关信息，也就是说，这个报文将被分成多个tcp分组，它们主要通过首部的“序号”字段来重新整合成一个整体。tcp协议是有连接的，也就是说，本机tcp和目的主机tcp会形成一个端到端的逻辑连接，后面的所有tcp数据都通过这条逻辑连接进行传输，简单来说，tcp连接就是本地主机和目的主机创建的socket、相关缓存、相关变量等。我们说创建了一条连接，也就是创建了上述的资源环境。tcp连接首先需要通过三次握手，第一次用来创建服务端连接环境（变量、缓存等），第二次握手用来告诉客户端服务端准备就绪并创建客户端环境（本机），第三次握手用来告诉服务端客户端准备就绪，此时连接创建，接下来服务端和客户度在接收到数据后都可以通过这条连接来将数据准确地交给对应的进程
5. 紧接着，这些报文段被发送给网络层进行处理，网络层会根据访问的ip来判断目的地址是否在当前子网内（通过本机预置的子网掩码），如果存在则直接跳到6，否则则需要找到本机设定的网关服务器ip。接下来添加上ip首部生成ip数据报
6. 接着数据被传输给数据链路层，数据链路层会使用 arp 协议查找对应ip的物理地址（如果是同一个子网则是url对应ip，否则是网关服务器ip），arp会向子网发送一个广播请求，对应ip的计算机会响应其mac地址。接着通过 CSMA/CD 协议检测链路是否空闲，如果空闲则发送ip数据报包装后生成的数据帧，具体发送见7
7. 物理层是实际发送数据的地方，数据帧会被转化为比特流，如通常的传输方式，比特流通过编码之后通过数据线以电流的方式发送到下一个目的地。
8. 当数据到达第一个路由器时，路由器会对数据进行反向解析直到网络层。通过提取的ip，路由器再依据路由表来判断数据应该从哪一个端口输出（相当于进入哪个子网），找到后，根据要发送到的下一个路由器的ip地址找到对应的mac，然后将数据的物理地址更改后重新包装，接着进入对应端口的队列尾部，等待输出。当到达最后一个路由器时（即当前路由器有一个端口处在请求ip对应的子网内），找到目的地址的arp，直接到达对应计算机。如果使用了负载均衡则跳到9，否则直接跳到10
9. 负载均衡会将用户的请求转发到后台内网服务器，内网服务器将请求的响应返回给负载均衡器，负载均衡器再将请求的响应发送客户。负载均衡分为四层负载均衡和七层负载均衡，区别主要在负载均衡工作的网络层次，如四层负载均衡工作在传输层，它会解析收到的数据并解析到传输层，如tcp报文段，然后通过修改数据报的地址信息来转发流量，进入步骤10。如果是七层负载均衡，它工作在应用层，它获取到http报文数据，并可根据请求的具体内容执行对应的请求策略，此时它会重新创建一个请求，并按照正常的方式访问对应的服务器，此时进入步骤2
10. 目的计算机会先运行服务器软件，用来响应请求（实际上就是创建了一个服务端socket，并通过无限循环监听指定端口）。获取该请求后，服务器执行和本地计算机相关的数据解析操作，解析出tcp报文段时，计算机会先将数据按序号进行重新排序，并将组合后的数据（即http报文）传输给上层协议，一般服务器会解析该报文段并生成对应的数据结构给相关的服务端软件使用，服务端软件可以使用java、c++、python等多种语言编写，根据请求内容，服务端软件执行相关的业务逻辑并将需要的资源文件通过html文件，css资源，图片的方式返回。这些数据同样是存放在http报文的实体部分。接下里的步骤和本地计算法发送数据基本一致。
11. 本地计算机收到数据后，一路解析到达http报文并将数据交给浏览器，浏览器根据一定的规范将收到的资源文件以恰当的形式展现在屏幕前。
