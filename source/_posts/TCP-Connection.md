---
title: tcp 三次握手 
date: 2017-07-07 09:53:11
tags:
    - tcp
    - 三次握手
---

> 以前看三次握手没领悟到要领，经常是过了几天就忘了 `SYN, ACK, SEQ` 这些参数以及对应的关系。后来系统学习tcp后，才明白要了解三次握手，熟悉报文结构是基础，也是关键。本文先介绍tcp连接以及tcp报文，它们涵盖了三次握手的大部分内容，最后再加上握手阶段的特殊条件整合三次握手的过程

<!-- more -->

## 什么是tcp连接
目前使用的传输层协议主要有两种，一种是无连接的udp，一种是有连接的tcp。**tcp连接是一种端到端的逻辑连接**，也就是说，tcp连接只存在于两个进行交互的端系统中，中间设备是看不到tcp连接的。因此大部分时候我们讨论tcp连接，都是在讨论端系统中具体的进程。连接主要体现在 **可识别** 这个特点上，比如进程A和进程B、C、D均建立了tcp连接，意味着，**A不仅可以接收并处理B、C、D发送过来的数据，同时也可以区分出对应数据的发送方**。因此连接实际上是一个逻辑概念，**具体实现上 ，tcp连接指两台主机上各自的缓存、变量和进程连接套接字。**  <strong style="color:red">而三次握手的过程，可以理解为初始化上述连接环境的过程。</strong>

## tcp报文段
要比较清晰的了解tcp的三次握手，必须先了解tcp报文段相关字段的具体含义。
下图截取了报文段中与tcp连接相关的字段信息
![](/images/TCP-Connection/tcp-datagram-1.png)

**端口号**
源端口号和目的端口号用来创建socket，我们可以简单地将socket理解为一个窗口，该窗口通过 `ip+port` 标识。数据将从该窗口出来，并从该窗口进入

**序号**
1. 序号是tcp报文段一个非常重要的概念，它相当于一个报文段的id。当我们从上层协议接收数据后，tcp会对这些数据进行拆分，并各自加上tcp首部信息，形成tcp数据报信息。也就是说，一个完整的http报文可能会被分成多个部分进行传输，在接收端也是先收到这样的多个数据报，然后再根据对应的序号来对它们进行重排序，最后组成一个完整的http报文。
2. tcp将数据看成一个无结构的、有序的字节流，并对该字节流的每个字节进行编号，tcp序号对应报文段首字节的字节流编号。如下图所示：
![](/images/TCP-Connection/tcp-seq.png)
传输层从上层接收到一个http报文，该报文数据总共1750字节，tcp将其分割为四个数据段，并添加tcp首部形成四个tcp报文段。根据每个报文段数据首字节编号，第一个报文段的序号为0，第二个报文段的序号为500，第三个报文段序号为1000，以此类推。

**确认号**
<span style="color: red">确认号用来指示当前主机希望对方下一个发送的报文段序号值。</span>
如下图所示主机a和主机b通信的两种情况
![](/images/TCP-Connection/tcp-ack.png)
情况1中，主机a首先发送了seq=0的报文段，主机b计算出该报文段中数据占500字节，因此它期望下一个收到的报文段序号为500，因此取 ack=500，主机a收到该确认报文段后，将会发送 seq=500 的报文段，以此类推
情况2中，主机b首先接收到 seq=500 的报文段，于是它希望主机a发送 seq=0 的报文段，于是设置 ack=0。

**SYN**
tcp报文具有六个一比特标志位，SYN为1时表示当前报文为同步报文段，称为SYN报文段

## tcp三次握手
当主机a要向主机b使用tcp协议发送数据时，需要先创建tcp连接，这个过程我们称为“三次握手”
如下图所示：
![](/images/TCP-Connection/tcp-conn.png)
**第一次握手**：客户端将SYN设置为1，表示这是一个SYN报文段，并生成一个随机初始序号 `client_isn`。
**第二次握手**：服务端接收到该报文段后，通过SYN字段可以判断这是一个连接请求，于是初始化相关的变量和缓存，然后同样创建一个SYN报文段，并随机选取一个初始序号 `server_isn`，同时设置确认号 `ack=client_isn`。前面我们看到，ack是希望对面主机发送的下一个报文的序号，因此正常情况下 `ack=client_isn+SYN报文段数据字节`，因为SYN报文段不存在数据，因此可以理解为该数据量小于等于1，因此直接做加一处理。
**第三次握手**：客户端收到该报SYN报文段后，同样向该连接分配缓存和创建相关的变量。然后创建一个普通的响应报文段对该SYN报文端进行响应。最后这次握手可以看成告诉服务端客户端已经初始化好了相关的连接信息。至此，连接创建。

## 其他
当一台服务器接收到大量的SYN报文段，将分配相关的缓存和变量后，但如果最终没有ACK确认，则会产生大量半开连接，服务端需要再将它们关闭，最终导致服务器资源消耗殆尽，这种情况称为 SYN洪泛攻击。基于这个特点，在第一次握手后，服务器一般不会马上分配缓存和变量，而是根据源、目的地址和端口以及服务器内置的加盐复杂函数生成一个cookie，该cookie与服务端返回的SYN报文段序号关联。此时，关于前一个SYN报文段的所有信息均保存在该序号中，也就是说，SYN报文段并不会给服务器留下任何信息。在客户端接收到SYN报文段后，将发送ack响应，服务器从响应报文的ack字段得到前一个SYN报文段的序号值，以此来判断该连接是否合法，如果合法再创建相应的缓存和变量。

## 最后
了解tcp报文结构，是学习三次握手的基本前提。

## 参考
[计算机网络-自顶向下方法][1]

[1]: https://book.douban.com/subject/26176870/